<?xml version="1.0"?>
<!--
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
-->
<project name="Bank Object Reference Demo" default="build" basedir=".">

    <property environment="env"/>
    <property name="build.dir" location="${basedir}/build"/>
    <property name="build.src.dir" location="${basedir}/build/src"/>
    <property name="build.classes.dir" location="${build.dir}/classes"/>

    <!-- Determine yoko.home, either from the environment varialble YOKO_HOME
       - or using ../../..
       -->
    <condition property="yoko.home" value="${env.YOKO_HOME}">
        <isset property="env.YOKO_HOME"/>
    </condition>
    <property name="yoko.home" location="../../.."/>

    <path id="yoko.classpath">
        <pathelement location="${build.classes.dir}"/>
        <pathelement location="${yoko.home}/lib/yoko-1.0-SNAPSHOT.jar"/>
    </path>

    <target name="build"> 
        <!--<antcall target="generate.corba.wsdl"/>-->
        <antcall target="generate.yoko.server.code"/>
        <antcall target="generate.yoko.client.code"/>
        <antcall target="generate.corba.server.code"/>
        <antcall target="generate.corba.client.code"/>
        <javac destdir="${build.classes.dir}" debug="true">
            <src path="${basedir}/src"/>
            <src path="${build.src.dir}"/>
            <classpath>
                <path refid="yoko.classpath"/>
                <pathelement path="${thirdparty.classpath}"/>
            </classpath>
        </javac>
    </target>

    <target name="generate.corba.wsdl">
        <echo level="info" message="Generating CORBA IDL and WSDL using wsdltoidl..."/>
        <wsdl2corba file="../resources/BankWS.wsdl" dest="BankWS-account.wsdl" binding="Account"/>
        <wsdl2corba file="BankWS-account.wsdl" dest="BankWS-corba.wsdl" binding="Bank"/>
        <wsdl2idl file="BankWS-corba.wsdl" dest="BankWS-corba.idl" binding="Bank"/>
        <echo level="info" message="Deleting intermediate BankWS-account.wsdl file..."/>
        <delete file="BankWS-account.wsdl"/>
    </target>
    
    <target name="generate.yoko.server.code">
        <echo level="info" message="Generating server code using wsdl2java..."/>
        <wsdl2java file="BankWS-corba.wsdl" package="yoko.server"/>
    </target>

    <target name="generate.corba.server.code">
        <echo level="info" message="Generating server code using idlj..."/>
        <idl2java file="BankWS-corba.idl" package="corba.server"/>
    </target>

    <target name="generate.yoko.client.code">
        <echo level="info" message="Generating client code using wsdl2java..."/>
        <wsdl2java file="BankWS-corba.wsdl" package="yoko.client"/>
    </target>

    <target name="generate.corba.client.code">
        <echo level="info" message="Generating client code using idlj..."/>
        <idl2java file="BankWS-corba.idl" package="corba.client"/>
    </target>

    <target name="clean">
        <delete dir="${build.classes.dir}"/>
        <delete dir="${build.src.dir}"/>
        <delete dir="${build.dir}"/>
        <delete file="endpoint.ior"/>
    </target>

    <macrodef name="wsdl2corba">
        <attribute name="file"/>
        <attribute name="dest"/>
        <attribute name="binding"/>
        <sequential>
            <java failonerror="true" classname="org.apache.yoko.tools.WSDLToIDL" fork="yes">
                <classpath>
                    <path refid="yoko.classpath"/>
                </classpath>
                <arg line="-d ${basedir} -corba -i @{binding} -o @{dest} @{file}"/>
            </java>
        </sequential>
    </macrodef>

    <macrodef name="wsdl2idl">
        <attribute name="file"/>
        <attribute name="dest"/>
        <attribute name="binding"/>
        <sequential>
            <java failonerror="true" classname="org.apache.yoko.tools.WSDLToIDL" fork="yes">
                <classpath>
                    <path refid="yoko.classpath"/>
                </classpath>
                <arg line="-d ${basedir} -idl -i @{binding} -o @{dest} @{file}"/>
            </java>
        </sequential>
    </macrodef>

    <macrodef name="wsdl2java">
        <attribute name="srcdestdir" default="${build.src.dir}"/>
        <attribute name="destdir" default="${build.classes.dir}"/>
        <attribute name="file"/>
        <attribute name="package"/>
        <sequential>
            <mkdir dir="@{srcdestdir}"/>
            <mkdir dir="@{destdir}"/>
            <java failonerror="true" 
                  classname="org.apache.cxf.tools.wsdlto.WSDLToJava">
                <arg line="-p @{package} -d @{srcdestdir} @{file}"/>
            </java>
        </sequential>
    </macrodef>

    <macrodef name="idl2java">
        <attribute name="srcdestdir" default="${build.src.dir}"/>
        <attribute name="destdir" default="${build.classes.dir}"/>
        <attribute name="file"/>
        <attribute name="package"/>
        <sequential>
            <mkdir dir="@{srcdestdir}"/>
            <mkdir dir="@{destdir}"/>
            <exec executable="idlj" dir=".">
                <arg line="-fall -td @{srcdestdir} -pkgPrefix Bank @{package} -pkgPrefix Account @{package} @{file}"/>
            </exec>
        </sequential>
    </macrodef>
</project>
